image: "debian:bookworm"

before_script:
  - apt-get update -y
  - apt-get install -y make sfst python3 python3-pip python3-venv locales git
  - python3 -m venv .venv
  - source .venv/bin/activate
  - locale-gen ml_IN.UTF-8

stages:
  - build
  - test
  - publish

build:
  stage: build
  script:
    - make
  artifacts:
    paths:
    - malayalam.a
    - python/dist/

test:
  stage: test
  script:
    - LC_ALL=ml_IN.UTF-8 make test
  dependencies:
    - build

publish:
  stage: publish
  script:
    - pip install twine
    - twine upload dist/* --username __token__ --password $PYPI_API_KEY
  only:
    - tags

